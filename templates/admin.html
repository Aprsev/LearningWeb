<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åå°ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; max-width: 1100px; margin: 0 auto; color: #333; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .user-info { font-size: 14px; background: #fff; padding: 5px 15px; border-radius: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .user-info span { font-weight: bold; color: #333; margin-right: 10px; }
        .user-info a { text-decoration: none; margin-left: 10px; }
        
        /* å¡ç‰‡å®¹å™¨ */
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { margin-top: 0; font-size: 18px; color: #2c3e50; border-left: 4px solid #007acc; padding-left: 10px; }
        
        /* è¾“å…¥ç»„ */
        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input[type="text"], input[type="number"], select { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none; transition: 0.2s; }
        input:focus { border-color: #007acc; }
        
        /* æŒ‰é’®æ ·å¼ */
        button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; color: white; background: #007acc; transition: 0.2s; font-size: 13px; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        
        .btn-green { background: #28a745; }
        .btn-red { background: #e74c3c; padding: 5px 10px; }
        .btn-purple { background: #8e44ad; }
        .btn-orange { background: #f39c12; }
        .btn-blue { background: #3498db; padding: 5px 10px; margin-right: 5px; }
        
        /* æ—¥å¿—æ¡† */
        #log-box { background: #1e1e1e; color: #4ec9b0; padding: 15px; height: 150px; overflow-y: auto; font-family: 'Consolas', monospace; border-radius: 6px; margin-top: 15px; font-size: 12px; line-height: 1.5; }
        
        /* è¡¨æ ¼æ ·å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; padding: 12px; background: #f8f9fa; color: #666; font-weight: 600; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
        tr:hover { background: #f8f9fa; }
        .tag { background: #e1ecf4; color: #39739d; padding: 2px 8px; border-radius: 12px; font-size: 12px; display: inline-block; }
        .diff-tag { font-weight: bold; font-size: 12px; }

        /* --- é€šç”¨å¼¹çª—æ ·å¼ --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: fadeIn 0.2s; max-height: 90vh; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #f9f9f9; border-radius: 0 0 8px 8px; }

        /* ç¼–è¾‘è¡¨å• */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: #555; }
        .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: 'Consolas', monospace; font-size: 13px; resize: vertical; box-sizing: border-box; }
        
        /* æ–‡ä»¶é€‰æ‹©åˆ—è¡¨ */
        .file-list-table tr { cursor: pointer; }
        .file-list-table tr:hover { background: #e6f7ff; }
        .file-list-table input { cursor: pointer; }

        /* ä¾èµ–åˆ—è¡¨ */
        #missing-libs-list { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 10px; border-radius: 4px; font-family: monospace; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div class="header">
        <h1 style="margin:0; font-size:24px; display:flex; align-items:center; gap:10px;">
            âš™ï¸ é¢˜åº“ç®¡ç†æ§åˆ¶å°
        </h1>
        <div class="user-info">
            <span>ğŸ‘¤ {{ user }}</span>
            <a href="/" style="color:#007acc;">è¿”å› IDE</a>
            <span style="color:#ddd; margin:0 5px;">|</span>
            <a href="/logout" style="color:#e74c3c;">é€€å‡ºç™»å½•</a>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“¥ 1. å¯¼å…¥æ–°é¢˜ç›® (GitHub)</h2>
        <div style="color:#666; font-size:13px; margin-bottom:10px;">è¾“å…¥å…¬å¼€ä»“åº“ URLï¼Œç¬¬ä¸€æ­¥ä»…æ‰«ææ–‡ä»¶ç»“æ„ï¼Œç¬¬äºŒæ­¥é€‰æ‹©æ–‡ä»¶è¿›è¡Œ AI åˆ†æå…¥åº“ã€‚</div>
        <div class="input-group">
            <input type="text" id="repo-url" placeholder="ä¾‹å¦‚: https://github.com/username/python-exercises.git">
            <button onclick="startScan()" id="btn-scan" style="width:150px;">ğŸ“¡ è¿æ¥ä»“åº“</button>
        </div>
        <div id="log-box">ç³»ç»Ÿå‡†å¤‡å°±ç»ª...</div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2>ğŸ“š ç°æœ‰é¢˜åº“ ({{ problems|length }})</h2>
            <button class="btn-purple" onclick="startOrganize()">âœ¨ AI æ™ºèƒ½å½’ç±»æ•´ç†</button>
        </div>
        <table>
            <thead>
                <tr>
                    <th width="50">ID</th>
                    <th>æ ‡é¢˜</th>
                    <th width="80">éš¾åº¦</th>
                    <th>çŸ¥è¯†ç‚¹</th>
                    <th>æ¥æº</th>
                    <th width="150">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for p in problems %}
                <tr id="row-{{ p.id }}">
                    <td>{{ p.id }}</td>
                    <td style="font-weight:500">{{ p.title }}</td>
                    <td><span class="diff-tag" style="color: {% if p.difficulty==1 %}#2ecc71{% elif p.difficulty==5 %}#e74c3c{% else %}#f39c12{% endif %}">Lv.{{ p.difficulty }}</span></td>
                    <td><span class="tag">{{ p.category }}</span></td>
                    <td style="font-size:12px; color:#999;">{{ p.source }}</td>
                    <td>
                        <button class="btn-blue" onclick='openEditModal({{ p|tojson }})'>âœï¸ ç¼–è¾‘</button>
                        <button class="btn-red" onclick="deleteProblem({{ p.id }})">ğŸ—‘ï¸</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="modal-overlay" id="file-modal">
        <div class="modal" style="width: 600px;">
            <div class="modal-header">
                <span>ğŸ“ é€‰æ‹©è¦åˆ†æçš„æ–‡ä»¶</span>
                <span id="select-count" style="font-size:12px; color:#666; font-weight:normal;">å·²é€‰ 0 ä¸ª</span>
            </div>
            <div class="modal-body" style="height: 400px; padding:0;">
                <table class="file-list-table" style="width:100%; margin:0;">
                    <tbody id="file-list-body"></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('file-modal')" style="background:#888;">å–æ¶ˆ</button>
                <button onclick="confirmProcess()" class="btn-green">ğŸš€ å¼€å§‹ AI åˆ†æå…¥åº“</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="edit-modal">
        <div class="modal" style="width: 800px;">
            <div class="modal-header">
                <span>âœï¸ ç¼–è¾‘é¢˜ç›®è¯¦æƒ…</span>
                <button onclick="closeModal('edit-modal')" style="background:transparent; color:#999; font-size:20px; padding:0;">Ã—</button>
            </div>
            <div class="modal-body" style="height: 600px;">
                <input type="hidden" id="edit-id">
                
                <div class="input-group">
                    <div style="flex:2">
                        <label style="display:block;margin-bottom:5px;font-weight:600">é¢˜ç›®æ ‡é¢˜</label>
                        <input type="text" id="edit-title">
                    </div>
                    <div style="flex:1">
                        <label style="display:block;margin-bottom:5px;font-weight:600">éš¾åº¦ (1-5)</label>
                        <input type="number" id="edit-difficulty" min="1" max="5">
                    </div>
                    <div style="flex:1">
                        <label style="display:block;margin-bottom:5px;font-weight:600">æ—¶é—´é™åˆ¶(ç§’)</label>
                        <input type="number" id="edit-timelimit" min="1" max="60" value="2">
                    </div>
                    <div style="flex:1">
                        <label style="display:block;margin-bottom:5px;font-weight:600">çŸ¥è¯†ç‚¹</label>
                        <input type="text" id="edit-category">
                    </div>
                </div>

                <div class="form-group">
                    <label>é¢˜ç›®æè¿° (Markdown æ ¼å¼)</label>
                    <textarea id="edit-desc" style="height: 150px;"></textarea>
                </div>

                <div class="form-group">
                    <label style="display:flex; justify-content:space-between; align-items:center;">
                        å‚è€ƒä»£ç  / ç¤ºä¾‹ä»£ç 
                        <button onclick="checkLibsInEdit(this)" class="btn-orange" style="font-size:11px; padding:3px 8px;">ğŸ› ï¸ æ£€æŸ¥ä¾èµ–åº“æ˜¯å¦å®‰è£…</button>
                    </label>
                    <textarea id="edit-code" style="height: 150px; color:#2c3e50;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('edit-modal')" style="background:#888;">å–æ¶ˆ</button>
                <button onclick="saveEdit()" class="btn-green">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="lib-modal">
        <div class="modal" style="width: 450px;">
            <div class="modal-header" style="color:#d35400;">âš ï¸ ç¯å¢ƒä¾èµ–ç¼ºå¤±æ£€æµ‹</div>
            <div class="modal-body">
                <p>æ£€æµ‹åˆ°å‚è€ƒä»£ç ä¸­ä½¿ç”¨äº†ä»¥ä¸‹å°šæœªå®‰è£…çš„åº“ï¼š</p>
                <div id="missing-libs-list"></div>
                <p style="font-size:13px; color:#666;">æ˜¯å¦ç«‹å³åœ¨æœåŠ¡å™¨(Docker)ç¯å¢ƒä¸­å®‰è£…è¿™äº›åº“ï¼Ÿ</p>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('lib-modal')" style="background:#888;">æš‚ä¸å®‰è£…</button>
                <button onclick="installLibs()" class="btn-green">ğŸ“¦ ç¡®è®¤å¹¶å®‰è£…</button>
            </div>
        </div>
    </div>

<script>
    // ================= å…¨å±€çŠ¶æ€ =================
    let isProcessing = false;
    let hasShownFileModal = false;
    let currentMissingLibs = [];

    // ================= è½®è¯¢ä¸æ‰«æ =================
    setInterval(async () => {
        try {
            const res = await fetch('/admin/scan_status');
            if(res.status === 401) {
                // å¦‚æœæœªç™»å½•ï¼Œè·³è½¬å›ç™»å½•é¡µ
                window.location.href = '/login';
                return; 
            }
            const data = await res.json();
            
            const btn = document.getElementById('btn-scan');
            const logBox = document.getElementById('log-box');

            // æ›´æ–°æ—¥å¿—
            if(data.logs.length > 0) {
                logBox.innerHTML = data.logs.join('<br>');
                logBox.scrollTop = logBox.scrollHeight;
            }

            // çŠ¶æ€æœº
            if (data.is_busy) {
                isProcessing = true;
                btn.disabled = true;
                btn.innerText = "â³ å¤„ç†ä¸­...";
            } else {
                btn.disabled = false;
                btn.innerText = "ğŸ“¡ è¿æ¥ä»“åº“";
                
                // é€»è¾‘ï¼šå¦‚æœä¸å¿™äº† + æœ‰æ–‡ä»¶ + ä¸”æ˜¯ä»å¿™ç¢ŒçŠ¶æ€å˜è¿‡æ¥ + è¿˜æ²¡å¼¹çª— => å¼¹çª—
                if (isProcessing && data.files.length > 0 && data.has_repo && !hasShownFileModal) {
                    showFileSelector(data.files);
                    hasShownFileModal = true;
                }
                
                // å¦‚æœä»»åŠ¡å®Œå…¨ç»“æŸï¼ˆdata.has_repo ä¼šåœ¨ process_selected åè¢«ç½®ä¸º falseï¼‰
                if (!data.has_repo) {
                    hasShownFileModal = false;
                }
                
                isProcessing = false;
            }
        } catch(e) { console.error(e); }
    }, 1500);

    async function startScan() {
        const url = document.getElementById('repo-url').value;
        if(!url) return alert("è¯·è¾“å…¥ URL");
        hasShownFileModal = false; 
        
        await fetch('/admin/scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ url: url })
        });
    }

    // ================= æ–‡ä»¶é€‰æ‹©é€»è¾‘ =================
    function showFileSelector(files) {
        const tbody = document.getElementById('file-list-body');
        tbody.innerHTML = "";
        
        if(files.length === 0) {
            tbody.innerHTML = "<tr><td style='text-align:center;padding:20px;color:#999'>æœªæ‰¾åˆ° .py æ–‡ä»¶</td></tr>";
        } else {
            files.forEach((f) => {
                tbody.innerHTML += `
                    <tr onclick="toggleRow(this)">
                        <td width="30"><input type="checkbox" class="file-chk" value="${f.index}" onchange="updateCount()"></td>
                        <td style="font-family:monospace; font-size:13px">${f.path}</td>
                    </tr>
                `;
            });
        }
        document.getElementById('file-modal').style.display = 'flex';
        updateCount();
    }

    async function confirmProcess() {
        const checkboxes = document.querySelectorAll('.file-chk:checked');
        const indices = Array.from(checkboxes).map(c => parseInt(c.value));
        
        if(indices.length === 0) return alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶");
        
        closeModal('file-modal');
        
        await fetch('/admin/import', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ indices: indices })
        });
        
        document.getElementById('log-box').innerHTML += "<br>ğŸš€ æŒ‡ä»¤å·²å‘é€ï¼ŒAI æ­£åœ¨åˆ†æé€‰ä¸­çš„æ–‡ä»¶ï¼Œè¯·è§‚å¯Ÿæ—¥å¿—...";
    }

    // ================= ç¼–è¾‘ä¸åº“ç®¡ç†é€»è¾‘ =================
    
    function openEditModal(problem) {
        document.getElementById('edit-id').value = problem.id;
        document.getElementById('edit-title').value = problem.title;
        document.getElementById('edit-difficulty').value = problem.difficulty;
        document.getElementById('edit-category').value = problem.category;
        
        // å¼‚æ­¥è·å–å®Œæ•´è¯¦æƒ…
        fetch(`/problem/${problem.id}`).then(r => r.json()).then(data => {
            // æ³¨æ„ï¼šAPI è¿”å›ç»“æ„æ˜¯ { detail: {...} }
            const detail = data.detail;
            document.getElementById('edit-desc').value = detail.description || "";
            document.getElementById('edit-code').value = detail.sample_code || "";
            document.getElementById('edit-timelimit').value = detail.time_limit || 2;
            document.getElementById('edit-modal').style.display = 'flex';
        });
    }

    async function saveEdit() {
        const data = {
            id: document.getElementById('edit-id').value,
            title: document.getElementById('edit-title').value,
            difficulty: parseInt(document.getElementById('edit-difficulty').value),
            category: document.getElementById('edit-category').value,
            description: document.getElementById('edit-desc').value,
            code: document.getElementById('edit-code').value,
            time_limit: parseInt(document.getElementById('edit-timelimit').value)
        };
        await fetch('/admin/update_problem', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        alert("ä¿å­˜æˆåŠŸï¼");
        location.reload();
    }

    async function checkLibsInEdit(btn) {
        const code = document.getElementById('edit-code').value;
        const originalText = btn.innerText;
        btn.innerText = "â³ åˆ†æä¸­...";
        btn.disabled = true;
        
        try {
            const res = await fetch('/admin/check_dependencies', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ problem_id: 0, code: code })
            });
            const data = await res.json();
            
            if (data.missing.length > 0) {
                currentMissingLibs = data.missing;
                document.getElementById('missing-libs-list').innerHTML = data.missing.map(l => `<div>ğŸ“¦ ${l}</div>`).join('');
                document.getElementById('lib-modal').style.display = 'flex';
            } else {
                alert("âœ… æ£€æµ‹é€šè¿‡ï¼šç¯å¢ƒå·²åŒ…å«æ‰€æœ‰ä¾èµ–åº“ã€‚");
            }
        } catch(e) {
            alert("æ£€æµ‹å‡ºé”™: " + e);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    async function installLibs() {
        const btn = document.querySelector('#lib-modal .btn-green');
        btn.innerText = "â³ å®‰è£…ä¸­...";
        btn.disabled = true;
        
        for (const lib of currentMissingLibs) {
            try {
                const res = await fetch('/admin/install_lib', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ lib_name: lib })
                });
                const data = await res.json();
                if(data.status !== 'ok') {
                    alert(`âŒ å®‰è£… ${lib} å¤±è´¥: ${data.msg}`);
                }
            } catch(e) { console.error(e); }
        }
        
        alert("âœ… å®‰è£…æµç¨‹ç»“æŸï¼");
        closeModal('lib-modal');
        btn.innerText = "ğŸ“¦ ç¡®è®¤å¹¶å®‰è£…";
        btn.disabled = false;
    }

    // ================= é€šç”¨è¾…åŠ©å‡½æ•° =================

    async function startOrganize() {
        if(!confirm("AI å°†æ‰«æå…¨éƒ¨é¢˜ç›®å¹¶é‡æ–°å½’çº³çŸ¥è¯†ç‚¹æ ‡ç­¾ï¼Œç¡®å®šå—ï¼Ÿ")) return;
        await fetch('/admin/organize', {method: 'POST'});
        alert("æ•´ç†ä»»åŠ¡å·²å¯åŠ¨ï¼Œè¯·ç•™æ„æ—¥å¿—ã€‚");
    }

    async function deleteProblem(pid) {
        if(!confirm("ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™é“é¢˜ç›®å—ï¼Ÿ")) return;
        await fetch(`/admin/delete/${pid}`, {method: 'POST'});
        document.getElementById(`row-${pid}`).remove();
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    function updateCount() {
        const count = document.querySelectorAll('.file-chk:checked').length;
        document.getElementById('select-count').innerText = `å·²é€‰ä¸­ ${count} ä¸ªæ–‡ä»¶`;
    }

    function toggleRow(tr) {
        // é˜²æ­¢ç‚¹å‡» checkbox æœ¬èº«è§¦å‘ä¸¤æ¬¡
        if(event.target.type === 'checkbox') return;
        
        const chk = tr.querySelector('input');
        chk.checked = !chk.checked;
        updateCount();
    }
</script>

</body>
</html>