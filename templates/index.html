<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>PyLearn Pro IDE</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

    <style>
        :root { --bg-dark: #1e1e1e; --bg-panel: #252526; --accent: #007acc; --text: #d4d4d4; --border: #333; }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 15px; font-family: 'Segoe UI', sans-serif; background: #121212; color: var(--text); height: 100vh; overflow: hidden; }
        
        .app-container { display: flex; height: 100%; gap: 10px; }
        
        /* ä¾§è¾¹æ  */
        .sidebar { width: 260px; background: var(--bg-panel); border: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 10px 15px; border-bottom: 1px solid var(--border); font-weight: bold; display: flex; justify-content: space-between; align-items: center; background: #333; }
        .problem-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .problem-list li { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #333; border-left: 3px solid transparent; font-size: 13px; }
        .problem-list li:hover { background: #37373d; }
        .problem-list li.active { background: #2a2d2e; border-left-color: var(--accent); }
        .meta-info { margin-bottom: 4px; display: flex; gap: 5px; flex-wrap: wrap; }
        .tag { font-size: 10px; background: #3c3c3c; padding: 1px 5px; border-radius: 3px; color: #aaa; }
        .diff-1 { color: #61bd4f; } .diff-5 { color: #c377e0; }

        /* å·¦æ  */
        .left-col { flex: 4; display: flex; flex-direction: column; gap: 10px; min-width: 0; }
        .panel { background: var(--bg-panel); border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .panel-header { padding: 8px 15px; background: #303031; font-weight: 600; border-bottom: 1px solid var(--border); font-size: 12px; color: #ccc; display: flex; justify-content: space-between; align-items: center; }
        
        .desc-panel { flex: 1; }
        .scroll-content { flex: 1; overflow: auto; padding: 15px; }
        .markdown-body { font-size: 13px; line-height: 1.6; color: #ccc; }
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #444; padding-bottom: 5px; margin-top: 10px; font-size: 1.2em; color: white; }
        .markdown-body pre { 
            background: #1e1e1e; 
            border: 1px solid #444; 
            padding: 10px; 
            border-radius: 6px; 
            overflow-x: auto; 
            font-family: 'Consolas', monospace;
            position: relative;
        }
        
        /* å¢åŠ ä¸€ä¸ª mac é£æ ¼çš„çº¢é»„ç»¿å°ç‚¹è£…é¥°ï¼Œå¢åŠ é«˜çº§æ„Ÿï¼ˆå¯é€‰ï¼‰ */
        .markdown-body pre::before {
            content: "â— â— â—";
            color: #555;
            font-size: 10px;
            position: absolute;
            top: 5px;
            left: 10px;
            letter-spacing: 2px;
        }
        .markdown-body pre code {
            display: block;
            margin-top: 15px; /* ç»™ä¸Šé¢çš„è£…é¥°ç•™ç©ºé—´ */
            background: transparent; /* è¦†ç›–é»˜è®¤æ ·å¼ */
            color: #d4d4d4;
            white-space: pre; /* æ ¸å¿ƒï¼šä¿ç•™æ¢è¡Œç¬¦ */
        }
        .markdown-body code { background: #383838; padding: 2px 4px; border-radius: 3px; font-family: Consolas; color: #ce9178; }

        .chat-panel { height: 35%; display: flex; flex-direction: column; border-top: 1px solid var(--border); }
        .chat-history { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; font-size: 13px; }
        .msg-user { align-self: flex-end; background: #0e639c; padding: 6px 10px; border-radius: 4px; color: white; max-width: 90%; }
        .msg-ai { align-self: flex-start; background: #333; padding: 6px 10px; border-radius: 4px; border: 1px solid #444; max-width: 95%; }
        .input-area { padding: 8px; border-top: 1px solid var(--border); display: flex; gap: 8px; background: #2d2d2d; }

        /* å³æ  */
        .right-col { flex: 6; display: flex; flex-direction: column; gap: 10px; min-width: 0; }
        .editor-container { flex: 2; background: #1e1e1e; position: relative; }
        .monaco-wrapper { 
            flex: 1; 
            display: flex; 
            overflow: hidden; 
            position: relative; /* ç¡®ä¿å®šä½å‡†ç¡® */
        }
        
        #monaco-editor { 
            flex: 1; 
            height: 100%; 
            min-width: 0; /* é˜²æ­¢å†…å®¹æ’‘å¼€ flex å®¹å™¨ */
        } 
        
        #monaco-diff { 
            flex: 1; 
            height: 100%; 
            display: none; 
            border-left: 1px solid #444; 
            min-width: 0; /* é˜²æ­¢å†…å®¹æ’‘å¼€ flex å®¹å™¨ */
        }

        .terminal-panel { height: 30%; background: #181818; font-family: 'Consolas', monospace; }
        /* æ ¸å¿ƒä¿®å¤ï¼šä¿ç•™æ¢è¡Œç¬¦ */
        .terminal-content { padding: 10px; color: #ccc; white-space: pre-wrap; font-size: 12px; line-height: 1.4; word-wrap: break-word; }

        button { cursor: pointer; border: none; padding: 4px 10px; border-radius: 2px; font-size: 11px; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        .btn-green { background: #238636; color: white; }
        .btn-orange { background: #d29922; color: white; }
        .btn-blue { background: var(--accent); color: white; }
        input[type="text"] { background: #3c3c3c; border: 1px solid #555; color: white; padding: 4px 8px; border-radius: 2px; flex: 1; outline: none; font-size: 12px; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #252526; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header"><span>ğŸ“š é¢˜åº“</span><a href="/admin" style="color:#aaa;text-decoration:none;font-size:12px">åå° ></a></div>
        <ul class="problem-list">
            {% for p in problems %}
            <li onclick="loadProblem(this, {{ p.id }})">
                <div class="meta-info"><span class="diff-{{ p.difficulty }}">Lv.{{ p.difficulty }}</span><span class="tag">{{ p.category }}</span></div>
                <div style="font-weight:500">{{ p.title }}</div>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div class="left-col">
        <div class="panel desc-panel">
            <div class="panel-header">ğŸ“ é¢˜ç›®æè¿°</div>
            <div class="scroll-content markdown-body" id="desc-content"><h3>ğŸ‘ˆ è¯·é€‰æ‹©é¢˜ç›®</h3></div>
        </div>
        <div class="panel chat-panel">
            <div class="panel-header">ğŸ¤– AI åŠ©æ•™</div>
            <div class="chat-history" id="chat-history"><div class="msg-ai">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI ç¼–ç¨‹åŠ©æ‰‹ã€‚</div></div>
            <div class="input-area">
                <input type="text" id="chat-input" placeholder="æœ‰ç–‘é—®ï¼Ÿé—®æˆ‘..." onkeydown="if(event.key==='Enter') sendChat()">
                <button class="btn-blue" onclick="sendChat()">å‘é€</button>
            </div>
        </div>
    </div>

    <div class="right-col">
        <div class="panel editor-container">
            <div class="panel-header">
                <span>ğŸ main.py</span>
                <div style="display:flex; gap:10px">
                    <button class="btn-orange" onclick="toggleSolution()">ğŸ‘€ å¯¹æ¯”ç­”æ¡ˆ</button>
                    <button class="btn-green" onclick="runCode()">â–¶ è¿è¡Œä»£ç </button>
                </div>
            </div>
            <div class="monaco-wrapper">
                <div id="monaco-editor"></div>
                <div id="monaco-diff"></div>
            </div>
        </div>
        <div class="panel terminal-panel">
            <div class="panel-header">
                <span>ğŸ–¥ï¸ ç»ˆç«¯è¾“å‡º</span>
                <button id="btn-ask-ai" class="btn-blue" style="display:none;" onclick="askAI()">ğŸ§  ä¸€é”®æ±‚åŠ©</button>
            </div>
            <div class="scroll-content terminal-content" id="output-text">ç­‰å¾…è¿è¡Œ...</div>
        </div>
    </div>
</div>
<script>
    // --- å…¨å±€å˜é‡ ---
    let editor = null;
    let diffEditor = null;
    let currentPid = null;
    
    // æš‚å­˜æ•°æ®ï¼Œé˜²æ­¢ç¼–è¾‘å™¨æœªåŠ è½½å®Œæ—¶æ•°æ®ä¸¢å¤±
    let pendingCode = "# è¯·åœ¨å·¦ä¾§é€‰æ‹©é¢˜ç›®...";
    let pendingSolution = "";

    // --- Monaco Editor åˆå§‹åŒ– ---
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
    
    require(['vs/editor/editor.main'], function() {
        // 1. åˆ›å»ºä¸»ç¼–è¾‘å™¨
        editor = monaco.editor.create(document.getElementById('monaco-editor'), {
            value: pendingCode, // åˆå§‹åŒ–æ—¶ä½¿ç”¨æš‚å­˜çš„æ•°æ®
            language: 'python',
            theme: 'vs-dark',
            automaticLayout: true, // è‡ªåŠ¨é€‚åº”å®¹å™¨å¤§å°
            minimap: { enabled: false },
            fontSize: 14,
            scrollBeyondLastLine: false
        });

        // 2. åˆ›å»ºç­”æ¡ˆç¼–è¾‘å™¨ (åªè¯»)
        diffEditor = monaco.editor.create(document.getElementById('monaco-diff'), {
            value: pendingSolution || "# æš‚æ— å‚è€ƒç­”æ¡ˆ", // åˆå§‹åŒ–æ—¶ä½¿ç”¨æš‚å­˜çš„æ•°æ®
            language: 'python',
            theme: 'vs-dark',
            readOnly: true,
            automaticLayout: true,
            minimap: { enabled: false },
            fontSize: 14,
            lineNumbers: 'off',
            scrollBeyondLastLine: false
        });
        
        console.log("Monaco Editor åˆå§‹åŒ–å®Œæˆ");
    });

    // --- ä¸šåŠ¡é€»è¾‘ ---

    async function loadProblem(li, pid) {
        // UI é€‰ä¸­çŠ¶æ€åˆ‡æ¢
        document.querySelectorAll('.problem-list li').forEach(el => el.classList.remove('active'));
        if(li) li.classList.add('active');
        currentPid = pid;

        // é‡ç½®ç•Œé¢
        document.getElementById('output-text').innerText = "ç­‰å¾…è¿è¡Œ...";
        document.getElementById('btn-ask-ai').style.display = 'none';
        
        // é»˜è®¤å…³é—­ç­”æ¡ˆåˆ†å±
        const diffEl = document.getElementById('monaco-diff');
        diffEl.style.display = 'none';
        if (editor) editor.layout(); 
        
        try {
            const res = await fetch(`/problem/${pid}`);
            const data = await res.json();
            const detail = data.detail;

            const fixedDesc = autoFixMarkdown(detail.description);

            // æ¸²æŸ“ Markdown æè¿°
            document.getElementById('desc-content').innerHTML = marked.parse(`## ${detail.title}\n${fixedDesc}`);
            
            // æ›´æ–°æš‚å­˜æ•°æ®
            pendingCode = "# è¯·åœ¨æ­¤å¤„ç¼–å†™ä½ çš„ä»£ç ...\n\n";
            pendingSolution = detail.sample_code || "# æš‚æ— å‚è€ƒç­”æ¡ˆ";

            // å°è¯•æ›´æ–°ç¼–è¾‘å™¨ (å¦‚æœç¼–è¾‘å™¨å·²åŠ è½½)
            if (editor) editor.setValue(pendingCode);
            if (diffEditor) diffEditor.setValue(pendingSolution);

        } catch (e) { console.error(e); }
    }

    // --- æ›¿æ¢åŸæœ‰çš„ toggleSolution å‡½æ•° ---
function toggleSolution() {
    const diffEl = document.getElementById('monaco-diff');
    const editorEl = document.getElementById('monaco-editor');
    const btn = document.querySelector('.btn-orange'); // è·å–æŒ‰é’®ä»¥æ”¹å˜çŠ¶æ€æ–‡å­—
    
    if (diffEl.style.display === 'block') {
        // --- éšè—æ¨¡å¼ ---
        diffEl.style.display = 'none';
        btn.innerText = "ğŸ‘€ å¯¹æ¯”ç­”æ¡ˆ";
        // å…³é”®ï¼šè§¦å‘ä¸€æ¬¡å¸ƒå±€æ›´æ–°ï¼Œè®©ä¸»ç¼–è¾‘å™¨å æ»¡ 100%
        if (editor) editor.layout();
    } else {
        // --- å¯¹æ¯”æ¨¡å¼ ---
        diffEl.style.display = 'block';
        btn.innerText = "âŒ å…³é—­å¯¹æ¯”";
        
        // ç¡®ä¿ diffEditor æœ‰å†…å®¹
        if (diffEditor && pendingSolution) {
            diffEditor.setValue(pendingSolution);
        }

        // å…³é”®ï¼šç”±äº DOM æ¸²æŸ“éœ€è¦æçŸ­çš„æ—¶é—´ï¼Œä½¿ç”¨ setTimeout ç¡®ä¿ flex å¸ƒå±€ç”Ÿæ•ˆåå† resize
        setTimeout(() => {
            if (editor) editor.layout();
            if (diffEditor) diffEditor.layout();
        }, 10);
    }
}

    async function runCode() {
        if(!currentPid) return alert("è¯·å…ˆé€‰é¢˜");
        // è·å–ä»£ç ï¼šä¼˜å…ˆä»ç¼–è¾‘å™¨è·å–ï¼Œå¦‚æœè¿˜æ²¡åŠ è½½å®Œåˆ™ç”¨æš‚å­˜æ•°æ®
        const code = editor ? editor.getValue() : pendingCode;
        
        const outDiv = document.getElementById('output-text');
        outDiv.innerHTML = "<span style='color:yellow'>â³ ç¼–è¯‘è¿è¡Œä¸­...</span>";
        document.getElementById('btn-ask-ai').style.display = 'none';

        try {
            const res = await fetch('/run', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ problem_id: currentPid, code: code })
            });
            const result = await res.json();

            let html = "";
            if (result.error) {
                html += `âŒ Runtime Error:\n${result.error}`;
                document.getElementById('btn-ask-ai').style.display = 'inline-block';
            } else {
                html += `æ ‡å‡†è¾“å‡º:\n${result.output || "(æ— è¾“å‡º)"}\n-------------------\n`;
                if (result.is_correct) {
                    html += `âœ… æ­å–œï¼æ‰€æœ‰æµ‹è¯•ç‚¹é€šè¿‡ï¼`; 
                } else {
                    // è¿™é‡Œ result.error åŒ…å«äº† main.py æ‹¼æ¥çš„è¯¦ç»†é”™è¯¯æŠ¥å‘Šï¼ˆç¬¬å‡ ç»„å‡ºé”™ï¼‰
                    html += `âš ï¸ ${result.error}`; 
                }
            }
            outDiv.innerText = html;

        } catch (e) { outDiv.innerText = "Error: " + e; }
    }

    async function sendChat(msgText = null, codeContext = "", errContext = "") {
        const input = document.getElementById('chat-input');
        const msg = msgText || input.value;
        if(!msg) return;

        const history = document.getElementById('chat-history');
        history.innerHTML += `<div class="msg-user">${msg}</div>`;
        if(!msgText) input.value = ""; 
        history.scrollTop = history.scrollHeight;
        
        const loadId = "loading-" + Date.now();
        history.innerHTML += `<div id="${loadId}" class="msg-ai">...</div>`;
        history.scrollTop = history.scrollHeight;

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    problem_id: currentPid, 
                    message: msg, 
                    code_context: codeContext,
                    error_context: errContext
                })
            });
            const data = await res.json();
            document.getElementById(loadId).remove();
            history.innerHTML += `<div class="msg-ai markdown-body">${marked.parse(data.reply)}</div>`;
            history.scrollTop = history.scrollHeight;
        } catch(e) { console.error(e); }
    }

    function askAI() {
        const code = editor ? editor.getValue() : "";
        sendChat("æˆ‘çš„ä»£ç æŠ¥é”™äº†ï¼Œè¯·å¸®æˆ‘åˆ†æã€‚", code, document.getElementById('output-text').innerText);
    }

    function autoFixMarkdown(text) {
        if (!text) return "";

        // 1. ç§»é™¤ AI ç»å¸¸é”™è¯¯ç”Ÿæˆçš„å­¤ç«‹ "bash"ã€"text" è¯­è¨€æ ‡è®°è¡Œ
        // ä¾‹å­ï¼š **è¾“å…¥ç¤ºä¾‹:** \n bash \n 3  ->  **è¾“å…¥ç¤ºä¾‹:** \n 3
        text = text.replace(/(?:\*\*|###)\s*(?:è¾“å…¥|Input|è¾“å‡º|Output).*?\n\s*(bash|text|python|shell)\s*\n/gi, (match, lang) => {
            return match.replace(lang, "").replace(/\n\s*\n/, "\n"); 
        });

        // 2. ã€æ ¸å¿ƒã€‘ç»™è£¸å¥”çš„è¾“å…¥/è¾“å‡ºå†…å®¹åŠ ä¸Šä»£ç å— (```)
        // æ­£åˆ™é€»è¾‘ï¼šæ‰¾åˆ° "è¾“å…¥ç¤ºä¾‹" æ ‡é¢˜ï¼Œæ•è·ä¸­é—´å†…å®¹ï¼Œç›´åˆ°é‡åˆ° "è¾“å‡º" æˆ– ç»“å°¾
        // åªæœ‰å½“å†…å®¹æ²¡æœ‰è¢« ``` åŒ…è£¹æ—¶æ‰å¤„ç†
        const pattern = /((?:\*\*|###)\s*(?:è¾“å…¥|Input|æ ·ä¾‹è¾“å…¥).*?)\n((?!```)[\s\S]+?)(\n(?:\*\*|###)\s*(?:è¾“å‡º|Output|æ ·ä¾‹è¾“å‡º)|$)/gi;
        
        text = text.replace(pattern, (match, header, content, nextHeader) => {
            // å»é™¤é¦–å°¾ç©ºç™½
            let cleanContent = content.trim(); 
            // é‡æ–°æ‹¼æ¥ï¼šæ ‡é¢˜ + ```text + å†…å®¹ + ``` + ä¸‹ä¸€ä¸ªæ ‡é¢˜
            return `${header}\n\`\`\`text\n${cleanContent}\n\`\`\`\n${nextHeader}`;
        });

        // 3. å¯¹ "è¾“å‡º" éƒ¨åˆ†ä¹ŸåšåŒæ ·çš„å¤„ç† (å¦‚æœè¾“å‡ºä¹Ÿæ˜¯è£¸å¥”çš„)
        const patternOut = /((?:\*\*|###)\s*(?:è¾“å‡º|Output|æ ·ä¾‹è¾“å‡º).*?)\n((?!```)[\s\S]+?)($)/gi;
        text = text.replace(patternOut, (match, header, content, end) => {
            let cleanContent = content.trim();
            return `${header}\n\`\`\`text\n${cleanContent}\n\`\`\`\n${end}`;
        });

        return text;
    }
</script>